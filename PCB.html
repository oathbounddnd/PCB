<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PCB Investigation Kit</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; user-select:none; }
    body {
      background:
        radial-gradient(circle at 30% 20%, rgba(64, 64, 64, 0.3), transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(96, 96, 96, 0.2), transparent 50%),
        linear-gradient(135deg, #2a2a2a, #1a1a1a);
      font-family:'Times New Roman', serif;
      color:#c0c0c0;
      height:100vh;
      overflow:hidden;
      position:relative;
    }
    .static-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:
        radial-gradient(circle at 20% 30%, rgba(128, 128, 128, 0.06) 1px, transparent 1px),
        radial-gradient(circle at 80% 70%, rgba(160, 160, 160, 0.04) 1px, transparent 1px);
      background-size:6px 6px, 8px 8px;
      animation: staticNoise 0.2s infinite;
      pointer-events:none;
      z-index:1;
    }
    @keyframes staticNoise { 0%{opacity:.5;} 50%{opacity:.8;} 100%{opacity:.5;} }

    .screen { position:relative; z-index:2; height:100vh; padding:20px; display:none; }
    .screen.active { display:flex; flex-direction:column; }

    .centered { justify-content:center; align-items:center; text-align:center; }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(145deg, #4a4a4a, #2a2a2a);
      border: 2px solid #888;
      color: #c0c0c0;
      border-radius: 8px;
      font-weight:bold;
      cursor:pointer;
      margin-top:12px;
    }
    .btn:active { transform:translateY(1px); }

    .pcb-logo {
      font-size: 28px;
      font-weight: bold;
      color: #a0a0a0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7), 0 0 15px #888888;
      margin-bottom: 10px;
      letter-spacing: 3px;
    }
    .home-subtitle {
      font-size: 16px;
      color: #888;
      margin-bottom: 40px;
      font-style: italic;
    }
    .game-code-input {
      width:200px; height:60px; font-size:28px; text-align:center;
      background:#1a1a1a; border:3px solid #666; border-radius:8px;
      color:#c0c0c0; letter-spacing:8px; margin-bottom:30px;
    }

    .tool-screen { align-items:center; }
    .header { text-align:center; margin-bottom:30px; width:100%; }
    .timer-display { font-size:32px; color:#90EE90; text-shadow:0 0 10px #90EE90; margin-bottom:20px; }
    .case-info { color:#888; margin-bottom:20px; }
    .tools-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; width:100%; max-width:400px; }
    .tool-btn {
      padding:30px 20px; background:linear-gradient(145deg, #383838, #2a2a2a);
      border:2px solid #666; border-radius:12px; text-align:center; cursor:pointer;
    }
    .tool-btn.disabled { opacity:.4; cursor:not-allowed; }
    .tool-icon { font-size:24px; margin-bottom:10px; }
    .tool-name { font-size:16px; font-weight:bold; }

    .emf-container { padding:20px; height:100vh; display:flex; flex-direction:column; position:relative; }
    .back-btn {
      position:absolute; top:20px; left:20px;
      padding:6px 10px; font-size:12px;
      background:linear-gradient(145deg, #3a3a3a, #2a2a2a);
      border:1px solid #666; border-radius:4px; cursor:pointer;
    }
    .status-bar {
      display:flex; justify-content:space-between; align-items:center;
      background:linear-gradient(135deg, rgba(42,42,42,.9), rgba(26,26,26,.9));
      border:2px solid #606060; padding:12px 18px; margin-bottom:20px; border-radius:8px;
    }
    .status-led { width:10px; height:10px; border-radius:50%; margin-right:8px; }
    .status-led.red { background:#8b0000; opacity:.3; }
    .status-led.green { background:#228b22; }
    .power-button { cursor:pointer; padding:6px 10px; border:1px solid #888; border-radius:4px; }
    .main-display { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .emf-meter {
      width:280px; height:280px; border:4px solid #888; border-radius:50%; position:relative; margin-bottom:30px;
      background: radial-gradient(circle at 30% 30%, #383838, #2a2a2a), radial-gradient(circle at 70% 70%, #404040, #2a2a2a);
    }
    .meter-face { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:240px; height:240px; border-radius:50%; }
    .dial-numbers, .scale-marks { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); }
    .dial-number { position:absolute; width:24px; height:24px; display:flex; align-items:center; justify-content:center; color:#b8b8b8; font-weight:bold; }
    .needle {
      position:absolute; top:50%; left:50%; width:3px; height:100px;
      background:#c0c0c0; transform-origin:bottom center;
      transform:translate(-50%, -100%) rotate(-90deg);
      transition:transform .3s ease;
    }
    .digital-reading {
      background:rgba(42,42,42,.6); border:2px solid #606060; border-radius:8px; padding:15px; text-align:center;
    }
    .emf-value { font-size:48px; }

    .ghost-status {
      position:fixed; top:20px; right:20px;
      background:rgba(42,42,42,0.9); border:1px solid #666; border-radius:5px;
      padding:10px; font-size:12px; color:#888; max-width:240px; z-index:10;
    }
  </style>
</head>
<body>
  <div class="static-overlay"></div>

  <!-- 1) CALIBRATION -->
  <div id="calibScreen" class="screen centered active">
    <h2 style="margin-bottom:12px;">Movement Calibration</h2>
    <p id="calibInstructions" style="max-width:300px; line-height:1.4;">
      Stand in the centre, face the TV.<br><br>
      Tap below and walk <strong>5 steps straight forward</strong>.
    </p>
    <button class="btn" id="calibActionBtn" onclick="startForwardCalib()">Start Forward</button>
    <p id="calibProgress" style="margin-top:10px; font-size:12px; color:#aaa;">Forward: 0 / 5</p>
  </div>

  <!-- 2) HOME -->
  <div id="homeScreen" class="screen centered">
    <div class="pcb-logo">PARANORMAL CONTAINMENT BUREAU</div>
    <div class="home-subtitle">Investigation Kit v2.1</div>
    <input type="text" class="game-code-input" id="gameCodeInput" maxlength="4" placeholder="----">
    <div style="margin-bottom: 20px; color: #888; font-size: 14px;">Enter 4-Digit Case File Code</div>
    <button class="btn" onclick="startInvestigation()">Start Investigation</button>
    <div style="margin-top: 40px; font-size: 12px; color: #666;">
      All players: same spot, same facing, same code.
    </div>
  </div>

  <!-- 3) TOOL SELECTION -->
  <div id="toolScreen" class="screen tool-screen">
    <div class="header">
      <h1>PCB Investigation Kit</h1>
      <div class="timer-display" id="timerDisplay">00:00:00</div>
      <div class="case-info">Case File: <span id="caseCode">----</span> | Status: <span id="investigationStatus">ACTIVE</span></div>
    </div>
    <div class="tools-grid">
      <div class="tool-btn" onclick="openTool('emf')">
        <div class="tool-icon">üìä</div>
        <div class="tool-name">EMF READER</div>
      </div>
      <div class="tool-btn disabled">
        <div class="tool-icon">üìª</div>
        <div class="tool-name">SPIRIT BOX</div>
      </div>
      <div class="tool-btn disabled">
        <div class="tool-icon">üé§</div>
        <div class="tool-name">EVP RECORDER</div>
      </div>
      <div class="tool-btn disabled">
        <div class="tool-icon">üì∑</div>
        <div class="tool-name">CAMERA</div>
      </div>
    </div>
    <button class="btn" onclick="endInvestigation()" style="margin-top: 40px; background: linear-gradient(145deg, #4a2a2a, #2a1a1a); border-color: #664444;">
      End Investigation
    </button>
  </div>

  <!-- 4) EMF -->
  <div id="emfScreen" class="screen">
    <div class="emf-container">
      <button class="back-btn" onclick="backToTools()">‚Üê TOOLS</button>
      <div class="emf-header" style="text-align:center; margin-bottom:15px;">
        <div style="font-size:22px; font-weight:bold; color:#a0a0a0;">ELECTROMAGNETIC FIELD DETECTOR</div>
        <div style="font-size:11px; color:#707070; font-style:italic;">Patent No. 1887-EMF-UK | Est. Her Majesty's Service</div>
      </div>
      <div class="status-bar">
        <div style="display:flex; align-items:center;">
          <div class="status-led red" id="powerLed" style="opacity:0.3;"></div>
          <span class="power-button" id="powerBtn" onclick="togglePower()">POWER</span>
        </div>
        <div style="display:flex; align-items:center;">
          <div class="status-led red" id="calibLed" style="opacity:0.3;"></div>
          <span>CALIBRATED</span>
        </div>
        <div style="display:flex; align-items:center;">
          <div class="status-led red" id="anomalyLed" style="opacity:0.3;"></div>
          <span>ANOMALY</span>
        </div>
      </div>
      <div class="main-display">
        <div class="emf-meter">
          <div class="meter-face">
            <div class="dial-numbers"></div>
            <div class="scale-marks"></div>
            <div class="needle"></div>
            <div class="needle-center" style="position:absolute; top:50%; left:50%; width:16px; height:16px; background:#d0d0d0; border-radius:50%; transform:translate(-50%,-50%);"></div>
          </div>
        </div>
        <div class="digital-reading">
          <div class="emf-value">0.00</div>
          <div class="emf-unit">Milligauss (Electromagnetic Flux)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEBUG -->
  <div class="ghost-status">
    <div><strong>DEBUG:</strong></div>
    <div>Calib: <span id="dbgCalibPhase">idle</span></div>
    <div>Ghost: (<span id="dbgGhostX">--</span>, <span id="dbgGhostY">--</span>)</div>
    <div>Player: (<span id="dbgPlayerX">--</span>, <span id="dbgPlayerY">--</span>)</div>
    <div>Steps: <span id="dbgSteps">0</span></div>
    <div>In Zone: <span id="dbgInZone">NO</span></div>
  </div>

  <script>
    // ===== GLOBAL STATE =====
    let currentScreen = 'calibScreen';

    // calibration phases: forward -> right -> back -> left -> done
    let calibPhase = 'idle';
    let forwardSamples = [];
    let rightSamples = [];
    let backSamples = [];
    let leftSamples = [];
    const REQUIRED_FORWARD = 5;
    const REQUIRED_OTHERS = 3;

    let lastStepTime = 0;

    // signatures
    let sigForward = null;
    let sigRight = null;
    let sigBack = null;
    let sigLeft = null;

    // game
    let gameCode = '';
    let investigationActive = false;
    let startTime = null;
    let timerInterval = null;

    // movement
    let playerX = 0;
    let playerY = 0;
    let stepCount = 0;
    let avgStepLength = 0.7;

    // ghost
    let ghostX = 0;
    let ghostY = 0;

    // EMF
    let devicePowered = false;
    let emfAnimationInterval = null;
    let currentEMF = 0.0;

    // ===== UI HELPERS =====
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      currentScreen = id;
    }

    function updateDebug() {
      document.getElementById('dbgCalibPhase').textContent = calibPhase;
      document.getElementById('dbgGhostX').textContent = ghostX ? ghostX.toFixed(2) : '--';
      document.getElementById('dbgGhostY').textContent = ghostY ? ghostY.toFixed(2) : '--';
      document.getElementById('dbgPlayerX').textContent = playerX.toFixed(2);
      document.getElementById('dbgPlayerY').textContent = playerY.toFixed(2);
      document.getElementById('dbgSteps').textContent = stepCount;
    }

    // ===== CALIBRATION =====
    function startForwardCalib() {
      calibPhase = 'forward';
      document.getElementById('calibInstructions').textContent =
        'Walk 5 normal steps straight ahead.';
      document.getElementById('calibActionBtn').style.display = 'none';
      document.getElementById('calibProgress').textContent = 'Forward: 0 / 5';
      updateDebug();
    }

    function startRightCalib() {
      calibPhase = 'right';
      document.getElementById('calibInstructions').textContent =
        'Turn RIGHT ~90¬∞ and walk 3 steps.';
      document.getElementById('calibProgress').textContent = 'Right: 0 / 3';
      updateDebug();
    }

    function startBackCalib() {
      calibPhase = 'back';
      document.getElementById('calibInstructions').textContent =
        'Turn BACK (180¬∞) and walk 3 steps.';
      document.getElementById('calibProgress').textContent = 'Back: 0 / 3';
      updateDebug();
    }

    function startLeftCalib() {
      calibPhase = 'left';
      document.getElementById('calibInstructions').textContent =
        'Turn LEFT ~90¬∞ and walk 3 steps.';
      document.getElementById('calibProgress').textContent = 'Left: 0 / 3';
      updateDebug();
    }

    function buildSignature(samples) {
      if (!samples.length) return null;
      let sx=0, sy=0, sz=0;
      samples.forEach(s => { sx+=s.x; sy+=s.y; sz+=s.z; });
      const n = samples.length;
      const v = { x: sx/n, y: sy/n, z: sz/n };
      const m = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);
      return m ? { x:v.x/m, y:v.y/m, z:v.z/m } : {x:0,y:0,z:0};
    }

    function finishCalibration() {
      calibPhase = 'done';
      sigForward = buildSignature(forwardSamples);
      sigRight   = buildSignature(rightSamples);
      sigBack    = buildSignature(backSamples);
      sigLeft    = buildSignature(leftSamples);

      document.getElementById('calibInstructions').textContent =
        'Calibration complete. Continue to case code.';
      const btn = document.getElementById('calibActionBtn');
      btn.style.display = 'inline-block';
      btn.textContent = 'Continue';
      btn.onclick = () => showScreen('homeScreen');
      document.getElementById('calibProgress').textContent = '';
      updateDebug();
    }

    function normalizeVec(v) {
      const m = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);
      if (!m) return {x:0,y:0,z:0};
      return {x:v.x/m, y:v.y/m, z:v.z/m};
    }

    // ===== DEVICE MOTION =====
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', function(e){
        const now = Date.now();
        const acc = e.acceleration && e.acceleration.x !== null ? e.acceleration : e.accelerationIncludingGravity;
        if (!acc) return;

        const mag = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
        if (mag > 3.8 && (now - lastStepTime) > 200) {
          lastStepTime = now;
          const sample = normalizeVec({x:acc.x, y:acc.y, z:acc.z});

          if (calibPhase === 'forward') {
            forwardSamples.push(sample);
            document.getElementById('calibProgress').textContent =
              'Forward: '+forwardSamples.length+' / '+REQUIRED_FORWARD;
            if (forwardSamples.length >= REQUIRED_FORWARD) {
              // we can estimate step length here if you want, for now keep 0.7
              startRightCalib();
            }
          } else if (calibPhase === 'right') {
            rightSamples.push(sample);
            document.getElementById('calibProgress').textContent =
              'Right: '+rightSamples.length+' / '+REQUIRED_OTHERS;
            if (rightSamples.length >= REQUIRED_OTHERS) {
              startBackCalib();
            }
          } else if (calibPhase === 'back') {
            backSamples.push(sample);
            document.getElementById('calibProgress').textContent =
              'Back: '+backSamples.length+' / '+REQUIRED_OTHERS;
            if (backSamples.length >= REQUIRED_OTHERS) {
              startLeftCalib();
            }
          } else if (calibPhase === 'left') {
            leftSamples.push(sample);
            document.getElementById('calibProgress').textContent =
              'Left: '+leftSamples.length+' / '+REQUIRED_OTHERS;
            if (leftSamples.length >= REQUIRED_OTHERS) {
              finishCalibration();
            }
          } else if (calibPhase === 'done' && investigationActive) {
            handleGameplayStep(sample);
          }
        }
      });
    }

    // ===== GAMEPLAY STEP CLASSIFICATION =====
    function handleGameplayStep(sampleVec) {
      // compare to 4 signatures
      const candidates = [];
      if (sigForward) candidates.push({name:'forward', sig:sigForward});
      if (sigRight)   candidates.push({name:'right',   sig:sigRight});
      if (sigBack)    candidates.push({name:'back',    sig:sigBack});
      if (sigLeft)    candidates.push({name:'left',    sig:sigLeft});

      let bestName = null;
      let bestDot = -999;
      candidates.forEach(c => {
        const dot = c.sig.x*sampleVec.x + c.sig.y*sampleVec.y + c.sig.z*sampleVec.z;
        if (dot > bestDot) {
          bestDot = dot;
          bestName = c.name;
        }
      });

      // move according to direction
      switch (bestName) {
        case 'forward': playerX += avgStepLength; break;
        case 'back':    playerX -= avgStepLength; break;
        case 'right':   playerY += avgStepLength; break;
        case 'left':    playerY -= avgStepLength; break;
      }
      stepCount++;
      checkGhostZone();
      updateDebug();
    }

    // ===== INVESTIGATION =====
    function caseCodeToDistance(code) {
      let sum=0;
      for (let i=0;i<code.length;i++) {
        const d = parseInt(code[i],10);
        if (!isNaN(d)) sum += d;
      }
      const t = (sum % 37) / 36; // 0..1
      return 2 + t * 2; // 2..4m
    }
    function caseCodeToAngle(code) {
      const n = parseInt(code,10);
      if (isNaN(n)) return 0;
      return n % 360;
    }

    function startInvestigation() {
      const input = document.getElementById('gameCodeInput');
      const code = input.value;
      if (code.length !== 4) {
        alert('Please enter a 4-digit code');
        return;
      }
      if (calibPhase !== 'done') {
        alert('Please complete calibration first.');
        return;
      }

      // place ghost from code
      const dist = caseCodeToDistance(code);
      const angDeg = caseCodeToAngle(code);
      const angRad = angDeg * Math.PI / 180;
      ghostX = Math.cos(angRad) * dist;
      ghostY = Math.sin(angRad) * dist;

      // reset player
      playerX = 0;
      playerY = 0;
      stepCount = 0;

      gameCode = code;
      investigationActive = true;
      startTime = Date.now();

      document.getElementById('caseCode').textContent = code;
      showScreen('toolScreen');
      startTimer();
      updateDebug();
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (!investigationActive || !startTime) return;
        const elapsed = Date.now() - startTime;
        const s = Math.floor(elapsed / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600)/60);
        const sec = s % 60;
        document.getElementById('timerDisplay').textContent =
          `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
      }, 1000);
    }

    function checkGhostZone() {
      const dx = playerX - ghostX;
      const dy = playerY - ghostY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const inZone = dist <= 1.0;
      document.getElementById('dbgInZone').textContent = inZone ? 'YES' : 'NO';
      return inZone;
    }

    function openTool(name) {
      if (name === 'emf') {
        showScreen('emfScreen');
      }
    }

    function endInvestigation() {
      if (!confirm('End investigation?')) return;
      investigationActive = false;
      gameCode = '';
      playerX = 0; playerY = 0; stepCount = 0;
      stopEMFReadings();
      showScreen('homeScreen');
      updateDebug();
    }

    function backToTools() {
      if (devicePowered) togglePower();
      showScreen('toolScreen');
    }

    // ===== EMF =====
    function createDial() {
      const dial = document.querySelector('.dial-numbers');
      const marks = document.querySelector('.scale-marks');
      if (!dial || !marks) return;
      for (let i=0;i<=10;i++) {
        const num = document.createElement('div');
        num.className = 'dial-number';
        num.textContent = i;
        const angle = 180 + (i * 18);
        const radius = 130;
        const rad = angle * Math.PI / 180;
        const x = Math.cos(rad) * radius;
        const y = Math.sin(rad) * radius;
        num.style.left = `calc(50% + ${x}px - 12px)`;
        num.style.top = `calc(50% + ${y}px - 12px)`;
        dial.appendChild(num);
      }
      for (let i=0;i<=10;i++) {
        const mark = document.createElement('div');
        mark.className = 'scale-mark';
        const mathAngle = 180 + (i*18);
        const cssAngle = mathAngle - 270;
        mark.style.transform = `rotate(${cssAngle}deg)`;
        marks.appendChild(mark);
      }
    }

    function updateEMFDisplay(val) {
      document.querySelector('.emf-value').textContent = val.toFixed(2);
      const needle = document.querySelector('.needle');
      if (needle) {
        const angle = -90 + (val * 18);
        needle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
      }
    }

    function generateEMFReading() {
      if (!devicePowered) return;
      let target;
      if (checkGhostZone()) {
        target = 4.8 + Math.random() * 0.4;
        document.getElementById('anomalyLed').style.opacity = '1';
      } else {
        target = 0.5 + (Math.random()-0.5)*0.3;
        document.getElementById('anomalyLed').style.opacity = '0.3';
      }
      currentEMF += (target - currentEMF) * 0.1;
      updateEMFDisplay(currentEMF);
    }

    function startEMFReadings() {
      if (emfAnimationInterval) clearInterval(emfAnimationInterval);
      emfAnimationInterval = setInterval(generateEMFReading, 200);
    }

    function stopEMFReadings() {
      if (emfAnimationInterval) clearInterval(emfAnimationInterval);
      emfAnimationInterval = null;
      currentEMF = 0.0;
      updateEMFDisplay(currentEMF);
      document.getElementById('anomalyLed').style.opacity = '0.3';
    }

    function togglePower() {
      if (!investigationActive) {
        alert('Start an investigation first');
        return;
      }
      devicePowered = !devicePowered;
      const powerLed = document.getElementById('powerLed');
      const calibLed = document.getElementById('calibLed');
      if (devicePowered) {
        powerLed.style.opacity = '1';
        calibLed.style.opacity = '1';
        startEMFReadings();
      } else {
        powerLed.style.opacity = '0.3';
        calibLed.style.opacity = '0.3';
        stopEMFReadings();
      }
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function(){
      createDial();
      // code input numeric
      document.getElementById('gameCodeInput').addEventListener('keypress', function(e){
        if (e.key === 'Enter') startInvestigation();
        if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Enter') {
          e.preventDefault();
        }
      });
      updateDebug();
    });
  </script>
</body>
</html>
